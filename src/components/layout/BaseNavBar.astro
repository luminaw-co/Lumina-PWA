---
import Container from "@/components/ui/Container.astro";
import Button from "@/components/ui/Button.astro";
import Icon from "@/components/ui/Icon.astro";
import Link from "@/components/ui/Link.astro";
import { services } from "@/data/services";

export const iconsRoute = "/icons/";
export const enterpriseRoute = "/enterprise/";

export const links = [
	{ href: "/", label: "Inicio" },
	{ href: `${enterpriseRoute}services`, label: "Servicios" },
	{ href: `${enterpriseRoute}cases`, label: "Casos" },
	{ href: `${enterpriseRoute}us`, label: "Nosotros" },
	{ href: `${enterpriseRoute}contact`, label: "Contacto" },
];

export const serviceLinks = services.map((s) => ({
	href: `${enterpriseRoute}services/${s.slug}`,
	label: s.title,
	desc: s.description ? s.description : undefined,
}));

export const iconsSrc = {
	ui: `${iconsRoute}ui/`,
	social: `${iconsRoute}social/`,
	brand: `/brand/`,
};

const pathname = Astro.url.pathname;
const isActive = (href: string) => pathname.startsWith(href);
---

<header
	class="fixed w-full top-0 z-50 backdrop-blur-lg backdrop-saturate-150 bg-[var(--nav-blur)] dark:bg-[var(--nav-blur)]"
>
	<Container
		as="div"
		class="h-auto flex items-center justify-between mx-0 max-w-full p-12 md:px-16 lg:px-32"
	>
		<a href="/" aria-label="Inicio" class="flex items-center gap-3">
			<img
				src={`${iconsSrc.brand}lumina-logo-light.svg`}
				alt="Lúmina"
				class="h-32 dark:hidden"
			/>
			<img
				src={`${iconsSrc.brand}lumina-logo-dark.svg`}
				alt="Lúmina"
				class="h-32 hidden dark:block"
			/>
		</a>

		<nav
			class="hidden md:flex items-center gap-32"
			aria-label="Navegación principal"
		>
			<ul role="list" class="flex items-center gap-32">
				{
					links.map((l) => (
						<li
							class={
								l.label === "Servicios" ? "relative group" : ""
							}
						>
							{l.label === "Servicios" ? (
								<>
									<div class="flex items-center select-none">
										<Link
											href={l.href}
											aria-current={
												isActive(l.href)
													? "page"
													: undefined
											}
											tabindex="0"
										>
											{l.label}
										</Link>
										<button
											type="button"
											class="flex items-center justify-center w-6 h-6 hover:bg-[var(--ui-hover)]/20 transition"
											id="services-drop-toggle"
											aria-label="Mostrar menú de servicios"
											tabindex="0"
										>
											<svg
												class="w-10 h-10 transition-transform duration-200 pointer-events-none"
												viewBox="0 0 20 20"
												fill="none"
												xmlns="http://www.w3.org/2000/svg"
												id="services-drop-arrow"
											>
												<path
													d="M6 8L10 12L14 8"
													stroke="#1E90FF"
													stroke-width="2"
													stroke-linecap="round"
													stroke-linejoin="round"
												/>
											</svg>
										</button>
									</div>
									<ul
										class="drop-menu"
										id="services-drop-menu"
									>
										{serviceLinks.map((s) => (
											<li class="relative group/item">
												<Link
													href={s.href}
													class="flex items-center py-4 transition w-full text-[14px] !text-left"
												>
													<span class="text-left">
														{s.label}
													</span>
													<span
														class="card-info"
														style="min-width: 220px; text-transform: none;"
													>
														{s.desc}
													</span>
												</Link>
											</li>
										))}
									</ul>
								</>
							) : (
								<Link
									href={l.href}
									aria-current={
										isActive(l.href) ? "page" : undefined
									}
								>
									{l.label}
								</Link>
							)}
						</li>
					))
				}
			</ul>
		</nav>

		<div class="hidden md:flex items-center gap-3">
			<button
				class="p-2 hover:bg-[var(--ui-hover)]/10"
				aria-label="Cambiar idioma"
			>
				<Icon src={`${iconsSrc.ui}switch-language.svg`} size="md" />
			</button>
			<button
				id="theme-toggle"
				aria-pressed="false"
				class="p-2 hover:bg-[var(--ui-hover)]/10"
				aria-label="Cambiar tema"
			>
				<Icon
					src={`${iconsSrc.ui}sun.svg`}
					size="md"
					class="hidden dark:inline-flex"
				/>
				<Icon
					src={`${iconsSrc.ui}moon.svg`}
					size="md"
					class="inline-flex dark:hidden"
				/>
			</button>
		</div>

		<button
			class="md:hidden p-2 hover:bg-[var(--ui-hover)]/10"
			id="menu-btn"
			aria-expanded="false"
			aria-controls="mobile-menu"
			aria-label="Abrir menú"
		>
			<Icon src={`${iconsSrc.ui}open-menu.svg`} />
		</button>
	</Container>

	<Container
		class="hidden md:flex fixed w-full left-0 z-40 justify-end items-center gap-4 px-32"
		style="top: 6.0rem; height: 0;"
	>
		<div class="flex gap-4 items-center justify-center">
			<Link href="/portfolio/" style="padding: 0.75rem 1.25rem;">
				Portfolio
			</Link>
			<Button
				href="mailto:wavival.dev@luminaw.co"
				target="_blank"
				icon="ui/send-email-white"
				text="Solicitar servicio"
			/>
		</div>
	</Container>

	<nav
		id="mobile-menu"
		aria-label="Menú móvil"
		aria-hidden="true"
		class="md:hidden absolute right-16 top-42 w-auto h-auto rounded-2xl bg-[var(--bg-page)] dark:bg-[var(--bg-page)] shadow-[var(--shadow-base)] opacity-0 translate-y-2 scale-95 invisible pointer-events-none transition-all duration-300 ease-out will-change-transform will-change-opacity motion-reduce:transition-none"
	>
		<div class="h-full flex flex-col justify-between items-end gap-32">
			<ul role="list" class="flex flex-col items-end gap-12">
				{
					links.map((l) => (
						<li>
							{l.label === "Servicios" ? (
								<details class="w-full">
									<summary class="cursor-pointer">
										{l.label}
									</summary>
									<ul class="flex flex-col gap-2 mt-2">
										{serviceLinks.map((s) => (
											<li>
												<Link
													href={s.href}
													class="flex flex-col px-4 py-2"
												>
													<span class="font-semibold">
														{s.label}
													</span>
													<span class="text-xs">
														{s.desc}
													</span>
												</Link>
											</li>
										))}
									</ul>
								</details>
							) : (
								<Link
									href={l.href}
									aria-current={
										isActive(l.href) ? "page" : undefined
									}
								>
									{l.label}
								</Link>
							)}
						</li>
					))
				}
			</ul>

			<div class="flex items-center gap-4">
				<button
					type="button"
					class="p-2 rounded-lg hover:bg-[var(--ui-hover)]/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--ui-link)]"
					aria-label="Cambiar idioma"
					id="lang-toggle-mobile"
				>
					<Icon src="/icons/ui/switch-language.svg" size="md" />
				</button>

				<button
					id="theme-toggle-mobile"
					aria-pressed="false"
					class="p-2 pr-0 rounded-lg hover:bg-[var(--ui-hover)]/10"
					aria-label="Cambiar tema"
				>
					<Icon
						src="/icons/ui/sun.svg"
						size="md"
						class="hidden dark:inline-flex"
					/>
					<Icon
						src="/icons/ui/moon.svg"
						size="md"
						class="dark:hidden"
					/>
				</button>
			</div>

			<Button
				href="mailto:contacto@lumina.dev"
				target="_blank"
				icon="ui/send-email-white"
				text="Contáctame"
			/>
		</div>
	</nav>

	<script is:raw>
		(function () {
			const btn = document.getElementById("menu-btn");
			const menu = document.getElementById("mobile-menu");

			function openMenu() {
				menu.classList.remove(
					"opacity-0",
					"translate-y-2",
					"scale-95",
					"invisible",
					"pointer-events-none",
				);
				menu.classList.add(
					"opacity-100",
					"translate-y-0",
					"scale-100",
					"visible",
					"pointer-events-auto",
				);
				btn.setAttribute("aria-expanded", "true");
				menu.setAttribute("aria-hidden", "false");
			}

			function closeMenu() {
				menu.classList.remove(
					"opacity-100",
					"translate-y-0",
					"scale-100",
					"visible",
					"pointer-events-auto",
				);
				menu.classList.add(
					"opacity-0",
					"translate-y-2",
					"scale-95",
					"invisible",
					"pointer-events-none",
				);
				btn.setAttribute("aria-expanded", "false");
				menu.setAttribute("aria-hidden", "true");
			}

			if (btn && menu) {
				let open = false;

				btn.addEventListener("click", () => {
					open ? closeMenu() : openMenu();
					open = !open;
				});

				document.addEventListener("keydown", (e) => {
					if (e.key === "Escape" && open) {
						closeMenu();
						open = false;
					}
				});
			}

			// Dropmenu Servicios: click para fijar
			const dropToggle = document.getElementById("services-drop-toggle");
			const dropMenu = document.getElementById("services-drop-menu");
			const dropArrow = document.getElementById("services-drop-arrow");
			const dropGroup = document.getElementById("services-group");
			let dropFixed = false;

			if (dropToggle && dropMenu && dropArrow && dropGroup) {
				dropToggle.addEventListener("click", (e) => {
					e.stopPropagation();
					dropFixed = !dropFixed;
					dropGroup.classList.toggle("drop-fixed", dropFixed);
					dropArrow.classList.toggle("rotate-180", dropFixed);
				});

				document.addEventListener("click", (e) => {
					if (
						dropFixed &&
						!dropMenu.contains(e.target) &&
						!dropToggle.contains(e.target)
					) {
						dropFixed = false;
						dropGroup.classList.remove("drop-fixed");
						dropArrow.classList.remove("rotate-180");
					}
				});
			}

			// Theme toggles
			const ids = ["theme-toggle", "theme-toggle-mobile"];
			const toggles = ids
				.map((id) => document.getElementById(id))
				.filter(Boolean);

			const KEY = "theme";
			const root = document.documentElement;

			function apply(theme) {
				const isDark = theme === "dark";
				root.classList.toggle("dark", isDark);
				toggles.forEach(
					(b) =>
						b &&
						b.setAttribute(
							"aria-pressed",
							isDark ? "true" : "false",
						),
				);
			}

			const saved = localStorage.getItem(KEY);
			const prefersDark =
				window.matchMedia &&
				window.matchMedia("(prefers-color-scheme: dark)").matches;
			apply(saved ? saved : prefersDark ? "dark" : "light");

			function toggleTheme() {
				const nowDark = !root.classList.contains("dark");
				localStorage.setItem(KEY, nowDark ? "dark" : "light");
				apply(nowDark ? "dark" : "light");
			}

			toggles.forEach(
				(b) => b && b.addEventListener("click", toggleTheme),
			);
		})();
	</script>
</header>
