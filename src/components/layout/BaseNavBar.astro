---
import Container from "@/components/ui/Container.astro";
import Button from "@/components/ui/Button.astro";
import Icon from "@/components/ui/Icon.astro";
import Link from "@/components/ui/Link.astro";
import { services } from "@/data/services";

export const iconsRoute = "/icons/";
export const enterpriseRoute = "/enterprise/";

export const links = [
	{ href: "/", label: "Inicio" },
	{ href: `${enterpriseRoute}services`, label: "Servicios" },
	{ href: `${enterpriseRoute}cases`, label: "Casos" },
	{ href: `${enterpriseRoute}us`, label: "Nosotros" },
	{ href: `${enterpriseRoute}contact`, label: "Contacto" },
];

export const serviceLinks = services.map((s) => ({
	href: `${enterpriseRoute}services/${s.slug}`,
	label: s.title,
	desc: s.description ? s.description : undefined,
}));

export const iconsSrc = {
	ui: `${iconsRoute}ui/`,
	social: `${iconsRoute}social/`,
	brand: `/brand/`,
};

const pathname = Astro.url.pathname;
const isActive = (href: string) => pathname.startsWith(href);
---

<style>
	@media (max-width: 767px) {
		#mobile-menu {
			left: 0 !important;
			right: 0 !important;
			width: 100vw !important;
			min-width: 0 !important;
			border-radius: 0 !important;
			background: red !important;
			top: 0;
			transform: translateX(100%);
			opacity: 0;
			transition:
				transform 0.45s cubic-bezier(0.4, 0, 0.2, 1),
				opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
		}
		#mobile-menu.open {
			transform: translateX(0);
			opacity: 1;
			pointer-events: auto;
			visibility: visible;
		}
		#mobile-menu.closing {
			transform: translateX(-100%);
			opacity: 0;
			/* NO pointer-events ni visibility aquí */
			transition:
				transform 0.45s cubic-bezier(0.4, 0, 0.2, 1),
				opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
		}
		#mobile-menu.closed {
			transform: translateX(100%);
			opacity: 0;
			pointer-events: none;
			visibility: hidden;
		}
		#mobile-menu .mobile-menu-content {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			width: 100%;
			padding: 0;
			gap: 2.5rem;
			position: relative;
			z-index: 10;
		}
		#mobile-menu ul,
		#mobile-menu .flex {
			align-items: center !important;
			justify-content: center !important;
		}
		#mobile-menu li,
		#mobile-menu .mobile-anim {
			opacity: 0;
			transform: translateX(-40px);
			transition:
				opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
				transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		}
		#mobile-menu.open li,
		#mobile-menu.open .mobile-anim {
			opacity: 1;
			transform: translateX(0);
		}
		#mobile-menu.closing li,
		#mobile-menu.closing .mobile-anim {
			opacity: 0;
			transform: translateX(40px);
			transition:
				opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
				transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		}
		#mobile-menu-toggle,
		#mobile-menu-close {
			position: fixed;
			top: 1.5rem;
			right: 1.5rem;
			z-index: 50;
			background: transparent;
			border: none;
			padding: 0.5rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		#mobile-menu-toggle.open {
			display: none;
		}
		#mobile-menu-close {
			display: none;
		}
		#mobile-menu.open + #mobile-menu-close {
			display: flex;
		}
		#mobile-menu.open ~ #mobile-menu-toggle {
			display: none;
		}
		#mobile-menu.open #mobile-menu-close {
			display: flex;
		}
		#mobile-menu.open #mobile-menu-toggle {
			display: none;
		}
		#mobile-menu.closing #mobile-menu-close {
			display: flex;
		}
		#mobile-menu.closing #mobile-menu-toggle {
			display: none;
		}
		/* Animación escalonada */
		#mobile-menu.open li:nth-child(1),
		#mobile-menu.closing li:nth-child(1) {
			transition-delay: 0.1s;
		}
		#mobile-menu.open li:nth-child(2),
		#mobile-menu.closing li:nth-child(2) {
			transition-delay: 0.2s;
		}
		#mobile-menu.open li:nth-child(3),
		#mobile-menu.closing li:nth-child(3) {
			transition-delay: 0.3s;
		}
		#mobile-menu.open li:nth-child(4),
		#mobile-menu.closing li:nth-child(4) {
			transition-delay: 0.4s;
		}
		#mobile-menu.open li:nth-child(5),
		#mobile-menu.closing li:nth-child(5) {
			transition-delay: 0.5s;
		}
		#mobile-menu.open .mobile-anim:nth-child(1),
		#mobile-menu.closing .mobile-anim:nth-child(1) {
			transition-delay: 0.6s;
		}
		#mobile-menu.open .mobile-anim:nth-child(2),
		#mobile-menu.closing .mobile-anim:nth-child(2) {
			transition-delay: 0.7s;
		}
		#mobile-menu.open .mobile-anim:nth-child(3),
		#mobile-menu.closing .mobile-anim:nth-child(3) {
			transition-delay: 0.8s;
		}
		#mobile-menu.open .mobile-anim:nth-child(4),
		#mobile-menu.closing .mobile-anim:nth-child(4) {
			transition-delay: 0.9s;
		}
		details > ul {
			transition:
				max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1),
				opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
			overflow: hidden;
			max-height: 500px;
			opacity: 1;
		}
		details:not([open]) > ul {
			max-height: 0;
			opacity: 0;
			pointer-events: none;
		}
		details > summary {
			list-style: none;
		}
		details > summary::-webkit-details-marker {
			display: none;
		}
		#mobile-menu-overlay {
			opacity: 1;
			transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			background: red !important;
		}
		#mobile-menu.closing #mobile-menu-overlay {
			opacity: 0;
			transition-delay: 0.5s; /* Espera a que salgan los elementos */
		}
		#mobile-menu.closed #mobile-menu-overlay {
			opacity: 0;
		}
		#mobile-menu .mobile-menu-content {
			z-index: 10;
		}
		#mobile-menu-overlay {
			z-index: 0;
		}
	}
</style>

<header
	class="fixed w-full top-0 z-50 backdrop-blur-lg backdrop-saturate-150 bg-[var(--nav-blur)] dark:bg-[var(--nav-blur)]"
>
	<Container
		as="div"
		class="h-auto flex items-center justify-between mx-0 max-w-full p-12 md:px-16 lg:px-32"
	>
		<a href="/" aria-label="Inicio" class="flex items-center gap-3">
			<img
				src={`${iconsSrc.brand}lumina-logo-light.svg`}
				alt="Lúmina"
				class="h-32 dark:hidden"
			/>
			<img
				src={`${iconsSrc.brand}lumina-logo-dark.svg`}
				alt="Lúmina"
				class="h-32 hidden dark:block"
			/>
		</a>

		<nav
			class="hidden md:flex items-center gap-32"
			aria-label="Navegación principal"
		>
			<ul role="list" class="flex items-center gap-32">
				{
					links.map((l) => (
						<li
							class={
								l.label === "Servicios" ? "relative group" : ""
							}
						>
							{l.label === "Servicios" ? (
								<>
									<div class="flex items-center select-none">
										<Link
											href={l.href}
											aria-current={
												isActive(l.href)
													? "page"
													: undefined
											}
											tabindex="0"
										>
											{l.label}
										</Link>
										<button
											type="button"
											class="flex items-center justify-center w-6 h-6 hover:bg-[var(--ui-hover)]/20 transition"
											id="services-drop-toggle"
											aria-label="Mostrar menú de servicios"
											tabindex="0"
										>
											<svg
												class="w-10 h-10 transition-transform duration-200 pointer-events-none"
												viewBox="0 0 20 20"
												fill="none"
												xmlns="http://www.w3.org/2000/svg"
												id="services-drop-arrow"
											>
												<path
													d="M6 8L10 12L14 8"
													stroke="#1E90FF"
													stroke-width="2"
													stroke-linecap="round"
													stroke-linejoin="round"
												/>
											</svg>
										</button>
									</div>
									<ul
										class="drop-menu"
										id="services-drop-menu"
									>
										{serviceLinks.map((s) => (
											<li class="relative group/item">
												<Link
													href={s.href}
													class="flex items-center py-4 transition w-full text-[14px] !text-left"
												>
													<span class="text-left">
														{s.label}
													</span>
													<span
														class="card-info"
														style="min-width: 220px; text-transform: none;"
													>
														{s.desc}
													</span>
												</Link>
											</li>
										))}
									</ul>
								</>
							) : (
								<Link
									href={l.href}
									aria-current={
										isActive(l.href) ? "page" : undefined
									}
								>
									{l.label}
								</Link>
							)}
						</li>
					))
				}
			</ul>
		</nav>

		<div class="hidden md:flex items-center gap-3">
			<button
				class="p-2 hover:bg-[var(--ui-hover)]/10"
				aria-label="Cambiar idioma"
			>
				<Icon src={`${iconsSrc.ui}switch-language.svg`} size="md" />
			</button>
			<button
				id="theme-toggle"
				aria-pressed="false"
				class="p-2 hover:bg-[var(--ui-hover)]/10"
				aria-label="Cambiar tema"
			>
				<Icon
					src={`${iconsSrc.ui}sun.svg`}
					size="md"
					class="hidden dark:inline-flex"
				/>
				<Icon
					src={`${iconsSrc.ui}moon.svg`}
					size="md"
					class="inline-flex dark:hidden"
				/>
			</button>
		</div>

		<!-- Botón de abrir menú mobile SIEMPRE visible en mobile -->
		<button
			id="mobile-menu-toggle"
			type="button"
			class="md:hidden p-2 hover:bg-[var(--ui-hover)]/10 fixed top-6 right-6 z-[60] bg-transparent"
			aria-expanded="false"
			aria-controls="mobile-menu"
			aria-label="Abrir menú"
		>
			<Icon src={`${iconsSrc.ui}open-menu.svg`} />
		</button>
	</Container>

	<Container
		class="hidden md:flex fixed w-full left-0 z-40 justify-end items-center gap-4 px-32"
		style="top: 6.0rem; height: 0;"
	>
		<div class="flex gap-4 items-center justify-center">
			<Link href="/portfolio/" style="padding: 0.75rem 1.25rem;">
				Portfolio
			</Link>
			<Button
				href="mailto:wavival.dev@luminaw.co"
				target="_blank"
				icon="ui/send-email-white"
				text="Solicitar servicio"
			/>
		</div>
	</Container>

	<nav
		id="mobile-menu"
		aria-label="Menú móvil"
		aria-hidden="true"
		class="md:hidden fixed left-0 top-0 w-screen h-screen z-50 flex flex-col closed"
	>
		<!-- Contenido del menú -->
		<div class="mobile-menu-content">
			<ul role="list" class="flex flex-col items-center gap-12 w-full">
				{
					links.map((l) => (
						<li>
							{l.label === "Servicios" ? (
								<details class="w-full">
									<summary class="cursor-pointer">
										{l.label}
									</summary>
									<ul class="flex flex-col gap-2 mt-2">
										{serviceLinks.map((s) => (
											<li>
												<Link
													href={s.href}
													class="flex flex-col px-4 py-2"
												>
													<span class="font-semibold">
														{s.label}
													</span>
													<span class="text-xs">
														{s.desc}
													</span>
												</Link>
											</li>
										))}
									</ul>
								</details>
							) : (
								<Link
									href={l.href}
									aria-current={
										isActive(l.href) ? "page" : undefined
									}
								>
									{l.label}
								</Link>
							)}
						</li>
					))
				}
			</ul>

			<div class="flex flex-col items-center gap-6 w-full">
				<div class="flex items-center gap-4 mobile-anim">
					<button
						type="button"
						class="p-2 rounded-lg hover:bg-[var(--ui-hover)]/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--ui-link)]"
						aria-label="Cambiar idioma"
						id="lang-toggle-mobile"
					>
						<Icon src="/icons/ui/switch-language.svg" size="md" />
					</button>

					<button
						id="theme-toggle-mobile"
						aria-pressed="false"
						class="p-2 pr-0 rounded-lg hover:bg-[var(--ui-hover)]/10"
						aria-label="Cambiar tema"
					>
						<Icon
							src="/icons/ui/sun.svg"
							size="md"
							class="hidden dark:inline-flex"
						/>
						<Icon
							src="/icons/ui/moon.svg"
							size="md"
							class="dark:hidden"
						/>
					</button>
				</div>

				<div class="mobile-anim w-full flex justify-center">
					<Button
						href="mailto:contacto@lumina.dev"
						target="_blank"
						icon="ui/send-email-white"
						text="Contáctame"
					/>
				</div>
			</div>
		</div>
		<!-- Overlay para cerrar al hacer clic fuera -->
		<div
			id="mobile-menu-overlay"
			class="absolute inset-0 w-full h-full"
			tabindex="-1"
		>
		</div>
		<!-- Botón de cerrar SIEMPRE al final y con z-[70] para estar encima del overlay -->
		<button
			id="mobile-menu-close"
			type="button"
			class="md:hidden p-2 fixed top-6 right-6 z-[70] bg-transparent"
			aria-label="Cerrar menú"
			style="display: none;"
		>
			<Icon src="/icons/ui/close-blue.svg" />
		</button>
	</nav>

	<script is:raw>
		(function () {
			const openBtn = document.getElementById("mobile-menu-toggle");
			const closeBtn = document.getElementById("mobile-menu-close");
			const menu = document.getElementById("mobile-menu");
			const overlay = document.getElementById("mobile-menu-overlay");

			let open = false;
			let closingTimeout = null;

			function openMenu() {
				if (closingTimeout) clearTimeout(closingTimeout);
				menu.classList.remove("closed", "closing");
				menu.classList.add("open");
				openBtn.setAttribute("aria-expanded", "true");
				menu.setAttribute("aria-hidden", "false");
				closeBtn.style.display = "flex";
				openBtn.style.display = "none";
				open = true;
			}

			function closeMenu() {
				if (!open) return;
				menu.classList.remove("open");
				menu.classList.add("closing");
				closeBtn.style.display = "flex";
				openBtn.style.display = "none";
				open = false;
				if (closingTimeout) clearTimeout(closingTimeout);
				closingTimeout = setTimeout(() => {
					menu.classList.remove("closing");
					menu.classList.add("closed");
					closeBtn.style.display = "none";
					openBtn.style.display = "flex";
				}, 800); // 0.5s para elementos + 0.3s para overlay
				menu.setAttribute("aria-hidden", "true");
				openBtn.setAttribute("aria-expanded", "false");
			}

			if (openBtn && menu && closeBtn) {
				openBtn.addEventListener("click", () => {
					openMenu();
				});

				closeBtn.addEventListener("click", () => {
					closeMenu();
				});

				document.addEventListener("keydown", (e) => {
					if (e.key === "Escape" && open) {
						closeMenu();
					}
				});

				// Cerrar al hacer clic fuera (overlay)
				if (overlay) {
					overlay.addEventListener("click", () => {
						if (open) {
							closeMenu();
						}
					});
				}
			}

			// Dropmenu Servicios: click para fijar
			const dropToggle = document.getElementById("services-drop-toggle");
			const dropMenu = document.getElementById("services-drop-menu");
			const dropArrow = document.getElementById("services-drop-arrow");
			const dropGroup = document.getElementById("services-group");
			let dropFixed = false;

			if (dropToggle && dropMenu && dropArrow && dropGroup) {
				dropToggle.addEventListener("click", (e) => {
					e.stopPropagation();
					dropFixed = !dropFixed;
					dropGroup.classList.toggle("drop-fixed", dropFixed);
					dropArrow.classList.toggle("rotate-180", dropFixed);
				});

				document.addEventListener("click", (e) => {
					if (
						dropFixed &&
						!dropMenu.contains(e.target) &&
						!dropToggle.contains(e.target)
					) {
						dropFixed = false;
						dropGroup.classList.remove("drop-fixed");
						dropArrow.classList.remove("rotate-180");
					}
				});
			}

			// Theme toggles
			const ids = ["theme-toggle", "theme-toggle-mobile"];
			const toggles = ids
				.map((id) => document.getElementById(id))
				.filter(Boolean);

			const KEY = "theme";
			const root = document.documentElement;

			function apply(theme) {
				const isDark = theme === "dark";
				root.classList.toggle("dark", isDark);
				toggles.forEach(
					(b) =>
						b &&
						b.setAttribute(
							"aria-pressed",
							isDark ? "true" : "false",
						),
				);
			}

			const saved = localStorage.getItem(KEY);
			const prefersDark =
				window.matchMedia &&
				window.matchMedia("(prefers-color-scheme: dark)").matches;
			apply(saved ? saved : prefersDark ? "dark" : "light");

			function toggleTheme() {
				const nowDark = !root.classList.contains("dark");
				localStorage.setItem(KEY, nowDark ? "dark" : "light");
				apply(nowDark ? "dark" : "light");
			}

			toggles.forEach(
				(b) => b && b.addEventListener("click", toggleTheme),
			);
		})();
	</script>
</header>
