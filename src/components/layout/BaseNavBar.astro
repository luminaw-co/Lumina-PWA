---
import Container from "@/components/ui/Container.astro";
import Button from "@/components/ui/Button.astro";
import Icon from "@/components/ui/Icon.astro";
import Link from "@/components/ui/Link.astro";
import email from "@/components/layout/BaseFooter.astro";
import { services } from "@/data/services";

export const iconsRoute = "/icons/";
export const enterpriseRoute = "/enterprise/";

export const links = [
	{ href: "/", label: "Inicio" },
	{ href: `${enterpriseRoute}services`, label: "Servicios" },
	{ href: `${enterpriseRoute}cases`, label: "Casos" },
	{ href: `${enterpriseRoute}us`, label: "Nosotros" },
	{ href: `${enterpriseRoute}contact`, label: "Contacto" },
];

export const serviceLinks = services.map((s) => ({
	href: `${enterpriseRoute}services/${s.slug}`,
	label: s.title,
	desc: s.description ? s.description : undefined,
}));

export const iconsSrc = {
	ui: `${iconsRoute}ui/`,
	social: `${iconsRoute}social/`,
	brand: `/brand/`,
	isometrics: `${iconsRoute}illustrations/isometrics/`,
};

const pathname = Astro.url.pathname;
const isActive = (href: string) => pathname.startsWith(href);
---

<header class="header-nav">
	<Container as="div" class="ctn-nav">
		<a href="/" aria-label="Inicio" class="flex items-center">
			<img
				src={`${iconsSrc.brand}lumina-logo-light.svg`}
				alt="Lúmina"
				class="h-32 dark:hidden"
			/>
			<img
				src={`${iconsSrc.brand}lumina-logo-dark.svg`}
				alt="Lúmina"
				class="h-32 hidden dark:block"
			/>
		</a>

		<nav class="nav-desktop" aria-label="Navegación principal">
			<ul role="list" class="flex items-center gap-32">
				{
					links.map((l) => (
						<li
							class={
								l.label === "Servicios" ? "relative group" : ""
							}
						>
							{l.label === "Servicios" ? (
								<>
									<div class="flex items-center">
										<Link
											href={l.href}
											aria-current={
												isActive(l.href)
													? "page"
													: undefined
											}
											tabindex="0"
										>
											{l.label}
										</Link>
										<button
											type="button"
											class="btn-icon"
											id="services-drop-toggle"
											aria-label="Mostrar menú de servicios"
											tabindex="0"
										>
											<svg
												class="w-10 h-10 transition-transform duration-200 pointer-events-none"
												viewBox="0 0 20 20"
												fill="none"
												xmlns="http://www.w3.org/2000/svg"
												id="services-drop-arrow"
											>
												<path
													d="M6 8L10 12L14 8"
													stroke="#1E90FF"
													stroke-width="2"
													stroke-linecap="round"
													stroke-linejoin="round"
												/>
											</svg>
										</button>
									</div>
									<ul
										class="drop-menu"
										id="services-drop-menu"
									>
										{serviceLinks.map((s) => (
											<li class="relative group/item">
												<Link
													href={s.href}
													class="nav-item-drop"
												>
													<span class="text-left">
														{s.label}
													</span>
													<span
														class="card-info"
														style="min-width: 220px; text-transform: none;"
													>
														{s.desc}
													</span>
												</Link>
											</li>
										))}
									</ul>
								</>
							) : (
								<Link
									href={l.href}
									aria-current={
										isActive(l.href) ? "page" : undefined
									}
								>
									{l.label}
								</Link>
							)}
						</li>
					))
				}
			</ul>
		</nav>

		<Container class="hidden md:flex items-center gap-3">
			<button class="p-2" aria-label="Cambiar idioma">
				<Icon src={`${iconsSrc.ui}switch-language.svg`} size="md" />
			</button>
			<button
				id="theme-toggle"
				aria-pressed="false"
				class="p-2"
				aria-label="Cambiar tema"
			>
				<Icon
					src={`${iconsSrc.ui}sun.svg`}
					size="md"
					class="hidden dark:inline-flex"
				/>
				<Icon
					src={`${iconsSrc.ui}moon.svg`}
					size="md"
					class="inline-flex dark:hidden"
				/>
			</button>
		</Container>

		<button
			class="md:hidden p-2"
			id="menu-btn"
			aria-expanded="false"
			aria-controls="mobile-menu"
			aria-label="Abrir menú"
		>
			<Icon src={`${iconsSrc.ui}open-menu.svg`} />
		</button>
	</Container>

	<Container class="ctn-sub-menu" style="top: 6.0rem; height: 0;">
		<div class="flex gap-4 items-center justify-center">
			<Link href="/portfolio/" style="padding: 0.75rem 1.25rem;">
				Portfolio
			</Link>
			<Button
				href={`mailto:${email}`}
				target="_blank"
				icon="ui/send-email-white"
				text="Solicitar servicio"
			/>
		</div>
	</Container>

	{}
	<nav
		id="mobile-menu"
		aria-label="Menú móvil"
		aria-hidden="true"
		class="nav-mobile -translate-y-full opacity-0 pointer-events-none"
	>
		<button
			type="button"
			id="mobile-menu-close"
			class="btn-close-menu"
			aria-label="Cerrar menú"
		>
			<Icon src={`${iconsSrc.ui}close.svg`} size="md" />
		</button>

		<ul role="list" class="nav-item">
			{
				links.map((l) => (
					<li>
						{l.label === "Servicios" ? (
							<>
								<div class="w-full flex items-center justify-start">
									<Link
										href={l.href}
										class="font-semibold"
										aria-current={
											isActive(l.href)
												? "page"
												: undefined
										}
									>
										{l.label}
									</Link>
									<button
										type="button"
										class="transition mobile-servicios-toggle"
										aria-label="Mostrar servicios"
									>
										<svg
											class="w-5 h-5 transition-transform duration-200"
											viewBox="0 0 20 20"
											fill="none"
											xmlns="http://www.w3.org/2000/svg"
										>
											<path
												d="M6 8L10 12L14 8"
												stroke="#1e90ff"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											/>
										</svg>
									</button>
								</div>
								<ul class="mobile-servicios-submenu flex flex-col gap-2 transition-all duration-300 overflow-hidden max-h-0 opacity-0 pointer-events-none pl-8">
									{serviceLinks.map((s) => (
										<li>
											<Link
												href={s.href}
												class="flex flex-col px-4 py-2 text-[14px]"
											>
												<span class="font-semibold">
													{s.label}
												</span>
											</Link>
										</li>
									))}
								</ul>
							</>
						) : (
							<Link
								href={l.href}
								aria-current={
									isActive(l.href) ? "page" : undefined
								}
							>
								{l.label}
							</Link>
						)}
					</li>
				))
			}
		</ul>

		<Container class="flex items-center justify-start gap-3">
			<Button
				href="mailto:contacto@lumina.dev"
				target="_blank"
				icon="ui/send-email-white"
				text="Contáctame"
			/>
			<button
				type="button"
				class="p-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--brand-blue)]"
				aria-label="Cambiar idioma"
				id="lang-toggle-mobile"
			>
				<Icon src={`${iconsSrc.ui}switch-language.svg`} size="md" />
			</button>
			<button
				id="theme-toggle-mobile"
				aria-pressed="false"
				class="p-2"
				aria-label="Cambiar tema"
			>
				<Icon
					src={`${iconsSrc.ui}sun.svg`}
					size="md"
					class="hidden dark:inline-flex"
				/>
				<Icon
					src={`${iconsSrc.ui}moon.svg`}
					size="md"
					class="dark:hidden"
				/>
			</button>
		</Container>
	</nav>

	<script is:raw>
		(function () {
			const btn = document.getElementById("menu-btn");
			const menu = document.getElementById("mobile-menu");

			function openMenu() {
				menu.classList.remove(
					"-translate-y-full",
					"opacity-0",
					"pointer-events-none",
				);
				menu.classList.add(
					"translate-y-0",
					"opacity-100",
					"pointer-events-auto",
				);
				btn.setAttribute("aria-expanded", "true");
				menu.setAttribute("aria-hidden", "false");
			}

			function closeMenu() {
				menu.classList.add(
					"-translate-y-full",
					"opacity-0",
					"pointer-events-none",
				);
				menu.classList.remove(
					"translate-y-0",
					"opacity-100",
					"pointer-events-auto",
				);
				btn.setAttribute("aria-expanded", "false");
				menu.setAttribute("aria-hidden", "true");
			}

			if (btn && menu) {
				let open = false;

				btn.addEventListener("click", () => {
					open ? closeMenu() : openMenu();
					open = !open;
				});

				document.addEventListener("keydown", (e) => {
					if (e.key === "Escape" && open) {
						closeMenu();
						open = false;
					}
				});
			}

			// Dropmenu Servicios: click para fijar
			const dropToggle = document.getElementById("services-drop-toggle");
			const dropMenu = document.getElementById("services-drop-menu");
			const dropArrow = document.getElementById("services-drop-arrow");
			const dropGroup = document.getElementById("services-group");
			let dropFixed = false;

			if (dropToggle && dropMenu && dropArrow && dropGroup) {
				dropToggle.addEventListener("click", (e) => {
					e.stopPropagation();
					dropFixed = !dropFixed;
					dropGroup.classList.toggle("drop-fixed", dropFixed);
					dropArrow.classList.toggle("rotate-180", dropFixed);
				});

				document.addEventListener("click", (e) => {
					if (
						dropFixed &&
						!dropMenu.contains(e.target) &&
						!dropToggle.contains(e.target)
					) {
						dropFixed = false;
						dropGroup.classList.remove("drop-fixed");
						dropArrow.classList.remove("rotate-180");
					}
				});
			}

			// Theme toggles
			const ids = ["theme-toggle", "theme-toggle-mobile"];
			const toggles = ids
				.map((id) => document.getElementById(id))
				.filter(Boolean);

			const KEY = "theme";
			const root = document.documentElement;

			function apply(theme) {
				const isDark = theme === "dark";
				root.classList.toggle("dark", isDark);
				toggles.forEach(
					(b) =>
						b &&
						b.setAttribute(
							"aria-pressed",
							isDark ? "true" : "false",
						),
				);
			}

			const saved = localStorage.getItem(KEY);
			const prefersDark =
				window.matchMedia &&
				window.matchMedia("(prefers-color-scheme: dark)").matches;
			apply(saved ? saved : prefersDark ? "dark" : "light");

			function toggleTheme() {
				const nowDark = !root.classList.contains("dark");
				localStorage.setItem(KEY, nowDark ? "dark" : "light");
				apply(nowDark ? "dark" : "light");
			}

			toggles.forEach(
				(b) => b && b.addEventListener("click", toggleTheme),
			);

			// Mobile Servicios desplegable
			document
				.querySelectorAll(".mobile-servicios-toggle")
				.forEach((btn) => {
					btn.addEventListener("click", function (e) {
						e.preventDefault();
						const submenu = btn
							.closest("li")
							.querySelector(".mobile-servicios-submenu");
						if (submenu) {
							submenu.classList.toggle("max-h-0");
							submenu.classList.toggle("opacity-0");
							submenu.classList.toggle("pointer-events-none");
							submenu.classList.toggle("max-h-[500px]");
							submenu.classList.toggle("opacity-100");
							submenu.classList.toggle("pointer-events-auto");
							// Opcional: rotar flecha
							btn.querySelector("svg").classList.toggle(
								"rotate-180",
							);
						}
					});
				});

			// Botón cerrar menú mobile
			const closeBtn = document.getElementById("mobile-menu-close");
			if (closeBtn) {
				closeBtn.addEventListener("click", () => {
					closeMenu();
					// Si tienes variable open, ponla en false:
					if (typeof open !== "undefined") open = false;
				});
			}
		})();
	</script>
</header>
