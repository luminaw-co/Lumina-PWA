---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Container from "@/components/ui/Container.astro";
import Button from "@/components/ui/Button.astro";
---

<BaseLayout>
	<Container
		class="content-center min-h-screen w-full justify-items-center max-w-[520px] m-auto p-3"
	>
		<p class="heading-3 !text-start">Agendar cita en Lúmina</p>
		<div class="p-3 flex flex-col gap-3 max-w-[520px] w-full">
			<p class="text-sm-center 2xl:text-left">
				Completa el formulario y te contactaremos en menos de 24 horas.
			</p>
			<form
				id="contactForm"
				class="max-w-[520px] w-full flex flex-col gap-2 relative"
				autocomplete="off"
				action="/api/submit-lead"
				method="post"
			>
				<div class="w-full flex flex-col gap-1">
					<label for="name" class="text-xs-left">Nombre</label>
					<input
						id="name"
						type="text"
						name="name"
						required
						placeholder="Ingresa tu nombre completo"
						class="input-form"
						autocomplete="name"
						style="background: var(--bg-card); color: var(--text-primary); border-radius: var(--radius-md);"
					/>
				</div>
				<div class="w-full flex flex-col gap-1">
					<label for="email" class="text-xs-left"
						>Correo electrónico</label
					>
					<input
						id="email"
						type="email"
						name="email"
						required
						placeholder="Ingresa tu correo electrónico"
						class="input-form"
						autocomplete="email"
						style="background: var(--bg-card); color: var(--text-primary); border-radius: var(--radius-md);"
					/>
				</div>
				<div class="w-full flex flex-col gap-1">
					<label for="phone" class="text-xs-left">Teléfono</label>
					<div class="flex gap-2">
						<input
							id="phone"
							type="tel"
							name="phone"
							required
							placeholder="+57 3001234567"
							pattern="^\+\d{1,3}[\s\d().-]{6,}$"
							title="Incluye el indicativo (ej. +57) seguido del número. Mínimo 6 dígitos."
							aria-describedby="phone-hint"
							class="input-form flex-1"
							autocomplete="tel"
							aria-label="Teléfono con indicativo (ej. +57 3001234567)"
							style="background: var(--bg-card); color: var(--text-primary); border-radius: var(--radius-md);"
						/>
					</div>
				</div>
				<fieldset class="w-full flex flex-col gap-1">
					<label class="text-xs-left">Objetivo</label>

					<div class="flex gap-2 flex-wrap">
						<div>
							<input
								type="radio"
								id="obj-design"
								name="objective"
								value="Diseño UX/UI"
								class="sr-only peer"
								required
							/>
							<label
								for="obj-design"
								class="input-form inline-flex items-center px-4 py-2 rounded cursor-pointer select-none peer-checked:bg-[var(--accent-link)] peer-checked:text-white peer-checked:shadow-md"
							>
								Diseño UX/UI
							</label>
						</div>

						<div>
							<input
								type="radio"
								id="obj-dev"
								name="objective"
								value="Desarrollo web"
								class="sr-only peer"
							/>
							<label
								for="obj-dev"
								class="input-form inline-flex items-center px-4 py-2 rounded cursor-pointer select-none peer-checked:bg-[var(--accent-link)] peer-checked:text-white peer-checked:shadow-md"
							>
								Desarrollo web
							</label>
						</div>

						<div>
							<input
								type="radio"
								id="obj-consult"
								name="objective"
								value="Consultoría"
								class="sr-only peer"
							/>
							<label
								for="obj-consult"
								class="input-form inline-flex items-center px-4 py-2 rounded cursor-pointer select-none peer-checked:bg-[var(--accent-link)] peer-checked:text-white peer-checked:shadow-md"
							>
								Consultoría
							</label>
						</div>

						<div>
							<input
								type="radio"
								id="obj-other"
								name="objective"
								value="Otro"
								class="sr-only peer"
							/>
							<label
								for="obj-other"
								class="input-form inline-flex items-center px-4 py-2 rounded cursor-pointer select-none peer-checked:bg-[var(--accent-link)] peer-checked:text-white peer-checked:shadow-md"
							>
								Otro
							</label>
						</div>
					</div>
				</fieldset>
				<div class="w-full flex flex-col gap-1">
					<label for="message" class="text-xs-left">Mensaje</label>
					<textarea
						id="message"
						name="message"
						placeholder="Cuéntanos brevemente sobre tu proyecto (opcional)."
						class="input-form"
						rows="3"
						style="background: var(--bg-card); color: var(--text-primary); border-radius: var(--radius-md);"
					></textarea>
				</div>
				<input type="hidden" name="source" value="contact-page" />
				<Button
					type="submit"
					icon="ui/send-email-white"
					text="Agendar llamada"
					class="text-[var(--button-sm)] mt-2"
				/>
				<p class="text-xs-left !text-center mt-1">
					Te contactaremos en menos de 24 horas. No compartimos tu
					información con terceros.
				</p>
				<div
					id="modalStatus"
					class="w-full mt-2 transition-all duration-500 ease-in-out opacity-0 scale-95 pointer-events-none absolute left-0"
					style="top:100%;"
				>
					<span
						id="modalMessage"
						class="block w-full px-4 py-3 rounded-lg bg-[var(--status-success)] text-[var(--text-dark)] shadow-lg text-center"
					></span>
				</div>
			</form>
		</div>
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const formEl = document.getElementById("contactForm");
				const modal = document.getElementById("modalStatus");
				const modalMsg = document.getElementById("modalMessage");
				if (
					!(formEl instanceof HTMLFormElement) ||
					!(modal instanceof HTMLElement) ||
					!(modalMsg instanceof HTMLElement)
				)
					return;
				const form = formEl;

				let timeoutId = null;
				function showModal(message, success = true) {
					modalMsg.textContent = message;
					modal.classList.remove(
						"opacity-0",
						"scale-95",
						"pointer-events-none",
					);
					modal.classList.add(
						"opacity-100",
						"scale-100",
						"pointer-events-auto",
					);
					modalMsg.style.background = success
						? "var(--status-success)"
						: "var(--status-error)";
					modalMsg.style.color = "var(--text-dark)";
					if (timeoutId) clearTimeout(timeoutId);
					timeoutId = setTimeout(hideModal, 4000);
				}
				function hideModal() {
					modal.classList.remove(
						"opacity-100",
						"scale-100",
						"pointer-events-auto",
					);
					modal.classList.add(
						"opacity-0",
						"scale-95",
						"pointer-events-none",
					);
				}

				form.addEventListener("submit", async (e) => {
					e.preventDefault();

					const phoneInput = document.getElementById("phone");
					let formData;
					if (phoneInput && phoneInput instanceof HTMLInputElement) {
						const raw = (phoneInput.value || "").trim();
						const normalized = raw.replace(/[\s().-]+/g, "");
						const digitsOnly = normalized.replace(/\D/g, "");
						if (
							!normalized.startsWith("+") ||
							digitsOnly.length < 6
						) {
							showModal(
								"Por favor incluye el indicativo en el teléfono (ej. +57) antes del número.",
								false,
							);
							phoneInput.focus();
							return;
						}
						formData = new FormData(form);
						formData.set("phone", normalized);
					} else {
						formData = new FormData(form);
					}

					try {
						const resp = await fetch(
							form.getAttribute("action") || "/api/submit-lead",
							{
								method: "POST",
								body: formData,
							},
						);
						if (resp.ok) {
							showModal("¡Formulario enviado con éxito!", true);
							form.reset();
						} else {
							let detail = "";
							try {
								const json = await resp.json();
								detail = json?.error ? ` — ${json.error}` : "";
							} catch {}
							showModal(
								"Error al enviar el formulario." + detail,
								false,
							);
						}
					} catch (err) {
						showModal(
							"Error de conexión. Intenta de nuevo.",
							false,
						);
					}
				});
			});
		</script>
	</Container>
</BaseLayout>
